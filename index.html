<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAP HUB - FINAL V10 STABLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #002b3d; --secondary: #189ad3; --accent: #10b981; --danger: #dc2626; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --inp-bg: #f1f5f9; }
        .dark-mode { --primary: #f1f5f9; --bg: #001f2d; --card: #1e293b; --text: #f8fafc; --border: #334155; --inp-bg: #334155; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; transition: 0.3s; }
        #app-shell { display: flex; height: 100vh; flex-direction: column; }
        @media (min-width: 1024px) { #app-shell { flex-direction: row; } }
        #sidebar { background: #001f2d; display: flex; overflow-x: auto; padding: 0.5rem; flex-shrink: 0; border-bottom: 4px solid var(--secondary); z-index: 40; }
        @media (min-width: 1024px) { #sidebar { flex-direction: column; width: 260px; height: 100vh; padding: 1.5rem; border-right: none; overflow-y: auto; } }
        .nav-item { padding: 12px 14px; border-radius: 8px; font-weight: 700; color: #94a3b8; font-size: 10px; text-transform: uppercase; cursor: pointer; white-space: nowrap; margin-right: 5px; transition: 0.2s; }
        @media (min-width: 1024px) { .nav-item { margin-right: 0; margin-bottom: 5px; font-size: 11px; } }
        .nav-item.active { background: var(--secondary); color: white; box-shadow: 0 4px 12px rgba(24, 154, 211, 0.4); }
        .page { display: none; height: 100%; overflow-y: auto; padding: 1rem; padding-bottom: 100px; flex: 1; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); background: var(--card); }
        table { width: 100%; min-width: 800px; text-align: left; border-collapse: collapse; }
        th { background: #001f2d; color: white; padding: 12px; font-size: 10px; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 600; }
        .inp { width: 100%; padding: 10px; background: var(--inp-bg); border: 1px solid var(--border); border-radius: 6px; font-weight: 600; font-size: 11px; margin-bottom: 5px; color: var(--text); outline: none; }
        .btn { padding: 10px 16px; border-radius: 6px; font-weight: 800; font-size: 10px; text-transform: uppercase; color: white; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-blue { background: var(--secondary); } .btn-green { background: var(--accent); } .btn-red { background: var(--danger); }
        #chat-bubble { position: fixed; bottom: 20px; right: 20px; width: 55px; height: 55px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; cursor: pointer; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        #chat-box { position: fixed; bottom: 85px; right: 20px; width: 320px; height: 450px; background: var(--card); border-radius: 15px; border: 2px solid var(--secondary); display: none; flex-direction: column; z-index: 99; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .tooth-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; }
        .tooth-btn { height: 25px; border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 8px; font-weight: 900; background: var(--inp-bg); }
        .tooth-btn.active { background: #ffd700; color: black; border-color: #eab308; box-shadow: 0 0 8px #ffd700; }
    </style>
</head>
<body>

    <div id="auth-layer" class="fixed inset-0 bg-[#001f2d] z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md text-center border-b-8 border-[#189ad3]">
            <h1 class="text-5xl font-black text-[#189ad3] italic mb-2">DAP HUB</h1>
            <p class="text-[10px] font-bold text-gray-400 tracking-widest mb-6">DENTAL ASSIST PH - V10</p>
            <div id="login-form">
                <input id="l-user" class="inp text-center uppercase !bg-gray-100 !text-black" placeholder="USERNAME">
                <input id="l-pass" type="password" class="inp text-center !bg-gray-100 !text-black" placeholder="PASSWORD">
                <button onclick="login()" class="btn btn-blue w-full py-4 text-sm mt-2 shadow-lg">ENTER SYSTEM</button>
                <p onclick="toggleReg(true)" class="mt-4 text-xs font-bold text-gray-400 cursor-pointer">REQUEST ACCOUNT</p>
            </div>
            <div id="reg-form" class="hidden">
                <input id="r-name" class="inp text-center uppercase !bg-gray-100 !text-black" placeholder="FULL NAME">
                <select id="r-role" class="inp text-center font-bold !bg-gray-100 !text-black">
                    <option value="DENTIST">DENTIST</option>
                    <option value="ACCOUNTING">ACCOUNTING</option>
                    <option value="HR">HR</option>
                    <option value="IT">IT</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
                <input id="r-pass" type="password" class="inp text-center !bg-gray-100 !text-black" placeholder="PASSWORD">
                <button onclick="register()" class="btn btn-green w-full py-4 text-sm mt-2">SUBMIT REQUEST</button>
                <p onclick="toggleReg(false)" class="mt-4 text-xs font-bold text-gray-400 cursor-pointer">BACK TO LOGIN</p>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        <div id="sidebar">
            <h2 class="hidden lg:block text-2xl font-black text-[#189ad3] italic mb-6">DAP HUB</h2>
            <div id="nav-list" class="flex lg:flex-col"></div>
            <button onclick="logout()" class="btn btn-red lg:mt-auto ml-auto lg:ml-0 mt-2">LOGOUT</button>
        </div>

        <main class="flex-1 relative">
            
            <section id="p-dashboard" class="page">
                <h1 class="text-2xl font-black uppercase mb-6">Command Center</h1>
                <div id="stats-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="card">
                        <h4 class="font-bold mb-4">Production Volume</h4>
                        <canvas id="chart1"></canvas>
                    </div>
                    <div class="card overflow-hidden">
                        <h4 class="font-bold mb-4">Order Status Distribution</h4>
                        <div class="overflow-x-auto">
                            <div style="min-width: 250px; height: 250px; margin: auto;">
                                <canvas id="chartPie"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="p-dentist" class="page">
                <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-black italic">Dentists</h1><div class="flex gap-2"><button onclick="openModal('den')" class="btn btn-green">ADD NEW</button></div></div>
                <div class="table-wrap"><table id="t-den"><thead><tr><th>ID</th><th>NAME</th><th>CLINIC</th><th>PHONE</th><th>LOC</th><th>ACTION</th></tr></thead><tbody id="b-den"></tbody></table></div>
            </section>

            <section id="p-order" class="page">
                <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-black italic text-[#189ad3]">Orders</h1><button onclick="openModal('ord')" class="btn btn-green">NEW ORDER</button></div>
                <div class="table-wrap"><table id="t-ord"><thead><tr><th>ID</th><th>PATIENT</th><th>DENTIST</th><th>STATUS</th><th>DUE</th><th>TOTAL</th><th>ACTION</th></tr></thead><tbody id="b-ord"></tbody></table></div>
            </section>

            <section id="p-voucher" class="page">
                <h1 class="text-2xl font-black mb-6 text-purple-600">Vouchers</h1>
                <div id="v-admin-box" class="card hidden">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="text-[10px] font-bold">CODE</label><input id="v-code" class="inp uppercase"></div>
                        <div><label class="text-[10px] font-bold">DISCOUNT %</label><input id="v-pct" type="number" class="inp"></div>
                        <div><label class="text-[10px] font-bold">EXPIRY DATE</label><input id="v-exp" type="date" class="inp"></div>
                    </div>
                    <button onclick="addVouch()" class="btn btn-blue w-full mt-2">CREATE VOUCHER</button>
                </div>
                <div id="v-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"></div>
            </section>

            <section id="p-hr" class="page">
                <h1 class="text-2xl font-black mb-6">Attendance Portal</h1>
                <div class="card text-center mb-6">
                    <h1 id="clock" class="text-6xl font-black mb-4">00:00:00</h1>
                    <div class="flex justify-center gap-4">
                        <button onclick="clock('IN')" class="btn btn-green px-10 py-4">CLOCK IN</button>
                        <button onclick="clock('OUT')" class="btn btn-red px-10 py-4">CLOCK OUT</button>
                    </div>
                </div>
                <div id="hr-master-view" class="hidden">
                    <h3 class="font-bold mb-2">Master Logs (HR/Admin Only)</h3>
                    <div class="table-wrap"><table id="t-hr"><thead><tr><th>USER</th><th>ACTION</th><th>TIME</th></tr></thead><tbody id="b-hr"></tbody></table></div>
                </div>
            </section>

            <section id="p-accounting" class="page">
                <h1 class="text-2xl font-black mb-6 italic">Price Masterlist</h1>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-20" id="price-grid"></div>
                <button onclick="savePrices()" class="btn btn-blue w-full py-4 fixed bottom-0 left-0 lg:left-[260px] right-0 z-10">UPDATE ALL PRICES</button>
            </section>

            <section id="p-settings" class="page">
                <h1 class="text-2xl font-black mb-6">Settings</h1>
                <button onclick="document.body.classList.toggle('dark-mode')" class="btn btn-blue w-full py-4 mb-4">TOGGLE DARK MODE</button>
                <button onclick="resetSys()" class="btn btn-red w-full py-4">FACTORY RESET SYSTEM</button>
            </section>

        </main>
    </div>

    <div id="chat-box">
        <div class="bg-[#189ad3] p-3 text-white font-bold flex justify-between rounded-t-xl">
            <span id="chat-header">MESSENGER</span>
            <button onclick="toggleChat()">X</button>
        </div>
        <div class="p-2 border-b bg-white">
            <select id="chat-to" class="inp mb-0 !bg-white !text-black" onchange="rChat()"></select>
        </div>
        <div id="chat-body" class="flex-1 p-3 overflow-y-auto bg-slate-100 text-[10px] space-y-2"></div>
        <div class="p-2 border-t bg-white flex gap-2">
            <input id="chat-in" class="inp mb-0 !bg-white !text-black" placeholder="Message...">
            <button onclick="sendChat()" class="btn btn-blue">SEND</button>
        </div>
    </div>
    <div id="chat-bubble" onclick="toggleChat()">ðŸ’¬</div>

    <div id="mod-den" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6">
            <h2 class="text-xl font-black mb-4">DENTIST PROFILE</h2>
            <input type="hidden" id="d-idx">
            <div class="grid grid-cols-2 gap-3">
                <input id="d-id" class="inp bg-gray-100" readonly placeholder="ID">
                <input id="d-name" class="inp" placeholder="FULL NAME">
                <input id="d-clinic" class="inp" placeholder="CLINIC NAME">
                <input id="d-phone" class="inp" placeholder="PHONE">
                <select id="d-loc" class="inp"></select>
            </div>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModals()" class="btn btn-red">CANCEL</button>
                <button onclick="saveDen()" class="btn btn-green">SAVE DENTIST</button>
            </div>
        </div>
    </div>

    <div id="mod-ord" class="fixed inset-0 bg-black/80 z-[100] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl p-6 overflow-y-auto max-h-[90vh]">
            <h2 class="text-xl font-black mb-4 text-[#189ad3]">CREATE NEW ORDER</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-black">
                <div>
                    <label class="text-[10px] font-bold">DENTIST</label>
                    <select id="o-den" class="inp"></select>
                    <label class="text-[10px] font-bold">PATIENT NAME</label>
                    <input id="o-pat" class="inp">
                    <label class="text-[10px] font-bold">DUE DATE</label>
                    <input id="o-due" type="date" class="inp">
                </div>
                <div>
                    <label class="text-[10px] font-bold">SELECT PRODUCTS</label>
                    <div id="o-prods" class="h-40 overflow-y-auto border p-2 rounded text-[9px] font-bold bg-gray-50"></div>
                </div>
                <div>
                    <label class="text-[10px] font-bold">TEETH SELECTOR</label>
                    <div id="o-teeth" class="tooth-grid mb-4"></div>
                    <div class="bg-slate-900 text-white p-4 rounded-xl text-center">
                        <small>TOTAL AMOUNT</small>
                        <h1 class="text-3xl font-black text-[#189ad3]">â‚±<span id="o-tot">0</span></h1>
                    </div>
                </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModals()" class="btn btn-red">CANCEL</button>
                <button onclick="saveOrd()" class="btn btn-green px-10">CONFIRM ORDER</button>
            </div>
        </div>
    </div>

    <script>
        const PRODS = ["PFM", "EMAX", "ZIRCONIA", "VENEERS", "TEMPORARY", "BRIDGE", "INLAY", "ONLAY", "METAL TRIAL", "REPAIR"];
        let S = {
            u: JSON.parse(localStorage.getItem('dap_v10_u')) || [{n:'ADMIN', p:'123', d:'IT', s:'active'}],
            d: JSON.parse(localStorage.getItem('dap_v10_d')) || [],
            o: JSON.parse(localStorage.getItem('dap_v10_o')) || [],
            v: JSON.parse(localStorage.getItem('dap_v10_v')) || [],
            pr: JSON.parse(localStorage.getItem('dap_v10_pr')) || {},
            hr: JSON.parse(localStorage.getItem('dap_v10_hr')) || [],
            locs: ["MANILA", "CEBU", "DAVAO"],
            msg: JSON.parse(localStorage.getItem('dap_v10_msg')) || [],
            curr: null
        };
        
        PRODS.forEach(p => { if(!S.pr[p]) S.pr[p] = 1500; });

        function sv() {
            localStorage.setItem('dap_v10_u', JSON.stringify(S.u));
            localStorage.setItem('dap_v10_d', JSON.stringify(S.d));
            localStorage.setItem('dap_v10_o', JSON.stringify(S.o));
            localStorage.setItem('dap_v10_v', JSON.stringify(S.v));
            localStorage.setItem('dap_v10_pr', JSON.stringify(S.pr));
            localStorage.setItem('dap_v10_hr', JSON.stringify(S.hr));
            localStorage.setItem('dap_v10_msg', JSON.stringify(S.msg));
        }

        // AUTH
        function login() {
            let u = document.getElementById('l-user').value.toUpperCase();
            let p = document.getElementById('l-pass').value;
            let acc = S.u.find(x => x.n === u && x.p === p);
            if(!acc) return alert('WRONG CREDENTIALS');
            S.curr = acc;
            document.getElementById('auth-layer').classList.add('hidden');
            document.getElementById('app-shell').classList.remove('hidden');
            initNav();
            initChat();
        }

        function logout() { location.reload(); }
        function toggleReg(x) { document.getElementById('login-form').classList.toggle('hidden', x); document.getElementById('reg-form').classList.toggle('hidden', !x); }

        function register() {
            let n = document.getElementById('r-name').value.toUpperCase();
            let r = document.getElementById('r-role').value;
            let p = document.getElementById('r-pass').value;
            if(!n || !p) return alert('FILL ALL FIELDS');
            S.u.push({n, d:r, p, s:'active'}); // Auto-active for demo, change to 'pending' if needed
            sv();
            alert('REQUEST SENT!');
            toggleReg(false);
        }

        // NAV
        function initNav() {
            let r = S.curr.d;
            let menu = ['dashboard', 'dentist', 'order', 'voucher', 'hr', 'accounting', 'settings'];
            document.getElementById('nav-list').innerHTML = menu.map(m => `<div onclick="go('${m}')" id="nav-${m}" class="nav-item">${m}</div>`).join('');
            go('dashboard');
        }

        function go(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('p-' + id).classList.add('active');
            if(document.getElementById('nav-' + id)) document.getElementById('nav-' + id).classList.add('active');
            
            if(id === 'dashboard') dash();
            if(id === 'dentist') rDen();
            if(id === 'order') rOrd();
            if(id === 'voucher') rVouch();
            if(id === 'hr') rHR();
            if(id === 'accounting') rAcc();
        }

        // DASHBOARD PIE
        function dash() {
            document.getElementById('stats-grid').innerHTML = `
                <div class="card border-l-4 border-blue-500"><b>TOTAL ORDERS</b><h2 class="text-2xl font-black">${S.o.length}</h2></div>
                <div class="card border-l-4 border-green-500"><b>SALES</b><h2 class="text-2xl font-black">â‚±${S.o.reduce((a,b)=>a+parseInt(b.tot.replace(/,/g,'')||0),0).toLocaleString()}</h2></div>
                <div class="card border-l-4 border-purple-500"><b>DENTISTS</b><h2 class="text-2xl font-black">${S.d.length}</h2></div>
                <div class="card border-l-4 border-orange-500"><b>STAFF</b><h2 class="text-2xl font-black">${S.u.length}</h2></div>
            `;
            
            if(window.c1) window.c1.destroy();
            window.c1 = new Chart(document.getElementById('chart1'), {
                type: 'bar',
                data: { labels: PRODS, datasets: [{ label: 'Units', data: PRODS.map(()=>Math.floor(Math.random()*20)), backgroundColor: '#189ad3' }] }
            });

            if(window.c2) window.c2.destroy();
            const stats = { 'PENDING': S.o.filter(x=>x.st==='PENDING').length, 'DONE': S.o.filter(x=>x.st==='DONE').length };
            window.c2 = new Chart(document.getElementById('chartPie'), {
                type: 'pie',
                data: { 
                    labels: ['PENDING', 'DONE'], 
                    datasets: [{ data: [stats.PENDING || 1, stats.DONE || 0], backgroundColor: ['#94a3b8', '#10b981'] }] 
                },
                options: { maintainAspectRatio: false }
            });
        }

        // DENTIST
        function rDen() {
            document.getElementById('b-den').innerHTML = S.d.map((x, i) => `
                <tr><td>${x.id}</td><td>${x.n}</td><td>${x.c}</td><td>${x.p}</td><td>${x.loc}</td>
                <td><button onclick="del('d', ${i})" class="text-red-500 font-bold">DEL</button></td></tr>
            `).join('');
        }

        // ORDERS
        function rOrd() {
            document.getElementById('b-ord').innerHTML = S.o.map((x, i) => `
                <tr><td>${x.id}</td><td>${x.pat}</td><td>${x.den}</td>
                <td><select onchange="updateOrdStat(${i}, this.value)" class="p-1 rounded bg-gray-200 text-[10px] font-bold">
                    <option ${x.st==='PENDING'?'selected':''}>PENDING</option>
                    <option ${x.st==='DONE'?'selected':''}>DONE</option>
                </select></td>
                <td>${x.due}</td><td>â‚±${x.tot}</td>
                <td><button onclick="del('o', ${i})" class="text-red-500 font-bold">DEL</button></td></tr>
            `).join('');
        }
        function updateOrdStat(i, v) { S.o[i].st = v; sv(); dash(); }

        // VOUCHERS
        function rVouch() {
            const isBoss = (S.curr.d === 'IT' || S.curr.d === 'ADMIN');
            document.getElementById('v-admin-box').classList.toggle('hidden', !isBoss);
            document.getElementById('v-list').innerHTML = S.v.map((v, i) => {
                const expired = new Date(v.exp) < new Date();
                return `<div class="card !p-3 flex justify-between items-center ${expired?'opacity-50':''}">
                    <div><b class="text-lg">${v.c}</b><p class="text-[10px]">DISCOUNT: ${v.p}% | EXP: ${v.exp}</p></div>
                    ${isBoss ? `<button onclick="del('v', ${i})" class="text-red-500">Ã—</button>` : ''}
                </div>`;
            }).join('');
        }
        function addVouch() {
            let c = document.getElementById('v-code').value.toUpperCase();
            let p = document.getElementById('v-pct').value;
            let e = document.getElementById('v-exp').value;
            if(c && p && e) { S.v.push({c, p, exp: e}); sv(); rVouch(); }
        }

        // HR
        function clock(a) {
            S.hr.push({u: S.curr.n, a, t: new Date().toLocaleString(), d: S.curr.d});
            sv();
            alert('SUCCESSFULLY CLOCKED ' + a);
            rHR();
        }
        function rHR() {
            const isBoss = ['HR', 'ACCOUNTING', 'IT', 'ADMIN'].includes(S.curr.d);
            document.getElementById('hr-master-view').classList.toggle('hidden', !isBoss);
            if(isBoss) {
                document.getElementById('b-hr').innerHTML = S.hr.map(x => `
                    <tr><td>${x.u} (${x.d})</td><td class="${x.a==='IN'?'text-green-500':'text-red-500'} font-bold">${x.a}</td><td>${x.t}</td></tr>
                `).join('');
            }
        }

        // ACCOUNTING
        function rAcc() {
            document.getElementById('price-grid').innerHTML = PRODS.map(p => `
                <div class="card !p-3 text-center">
                    <label class="text-[9px] font-black">${p}</label>
                    <input class="inp text-center p-val" data-p="${p}" value="${S.pr[p]}">
                </div>
            `).join('');
        }
        function savePrices() {
            document.querySelectorAll('.p-val').forEach(i => S.pr[i.dataset.p] = i.value);
            sv();
            alert('PRICES UPDATED');
        }

        // MESSENGER
        function initChat() {
            const sel = document.getElementById('chat-to');
            sel.innerHTML = `<option value="EVERYONE">ðŸ“¢ EVERYONE (Public)</option>
                             <option value="STAFF">ðŸ‘¥ STAFF ONLY (No Dentist)</option>` + 
                             S.u.map(x => `<option value="${x.n}">${x.n} [${x.d}]</option>`).join('');
            rChat();
        }
        function toggleChat() { 
            const b = document.getElementById('chat-box');
            b.style.display = b.style.display === 'flex' ? 'none' : 'flex';
        }
        function sendChat() {
            let t = document.getElementById('chat-to').value;
            let m = document.getElementById('chat-in').value;
            if(!m) return;
            S.msg.push({f: S.curr.n, r: S.curr.d, t, m, ts: new Date().toLocaleTimeString()});
            sv();
            document.getElementById('chat-in').value = '';
            rChat();
        }
        function rChat() {
            let t = document.getElementById('chat-to').value;
            let filt = S.msg.filter(x => {
                if(t === 'EVERYONE') return x.t === 'EVERYONE';
                if(t === 'STAFF') return x.t === 'STAFF' && S.curr.d !== 'DENTIST';
                return (x.f === S.curr.n && x.t === t) || (x.f === t && x.t === S.curr.n);
            });
            document.getElementById('chat-body').innerHTML = filt.map(x => `
                <div class="${x.f===S.curr.n?'text-right':'text-left'}">
                    <small class="block opacity-50 text-[7px]">${x.f} (${x.r})</small>
                    <span class="inline-block p-2 rounded-lg ${x.f===S.curr.n?'bg-blue-500 text-white':'bg-white border'}">${x.m}</span>
                </div>
            `).join('');
        }

        // MODALS & HELPERS
        function openModal(t) {
            if(t==='den') {
                document.getElementById('d-idx').value = '';
                document.getElementById('d-id').value = 'D-' + Date.now().toString().slice(-4);
                document.getElementById('d-loc').innerHTML = S.locs.map(l => `<option>${l}</option>`).join('');
                document.getElementById('mod-den').style.display = 'flex';
            }
            if(t==='ord') {
                document.getElementById('o-den').innerHTML = S.d.map(d => `<option>${d.n}</option>`).join('');
                document.getElementById('o-prods').innerHTML = PRODS.map(p => `
                    <label class="flex items-center gap-2 mb-1"><input type="checkbox" class="ochk" value="${p}" onchange="calcOrd()"> ${p} (â‚±${S.pr[p]})</label>
                `).join('');
                let teeth = ''; for(let i=1; i<=32; i++) teeth += `<div class="tooth-btn" onclick="this.classList.toggle('active');calcOrd()">${i}</div>`;
                document.getElementById('o-teeth').innerHTML = teeth;
                document.getElementById('mod-ord').style.display = 'flex';
            }
        }
        function closeModals() { 
            document.getElementById('mod-den').style.display = 'none'; 
            document.getElementById('mod-ord').style.display = 'none'; 
        }
        function calcOrd() {
            let sum = 0;
            document.querySelectorAll('.ochk:checked').forEach(c => sum += parseInt(S.pr[c.value]));
            let count = document.querySelectorAll('.tooth-btn.active').length || 1;
            document.getElementById('o-tot').innerText = (sum * count).toLocaleString();
        }
        function saveDen() {
            S.d.push({id: document.getElementById('d-id').value, n: document.getElementById('d-name').value.toUpperCase(), c: document.getElementById('d-clinic').value, p: document.getElementById('d-phone').value, loc: document.getElementById('d-loc').value});
            sv(); rDen(); closeModals();
        }
        function saveOrd() {
            S.o.push({id: 'ORD-' + Date.now().toString().slice(-4), pat: document.getElementById('o-pat').value.toUpperCase(), den: document.getElementById('o-den').value, st: 'PENDING', due: document.getElementById('o-due').value, tot: document.getElementById('o-tot').innerText});
            sv(); rOrd(); dash(); closeModals();
        }
        function del(k, i) {
            if(confirm('DELETE ITEM?')) {
                if(k==='d') S.d.splice(i, 1);
                if(k==='o') S.o.splice(i, 1);
                if(k==='v') S.v.splice(i, 1);
                sv(); go('dashboard');
            }
        }
        function resetSys() { if(confirm('WIPE ALL DATA?')) { localStorage.clear(); location.reload(); } }
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString(), 1000);
    </script>
</body>
</html>
