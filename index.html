<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAP HUB</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #002b3d; --secondary: #189ad3; --accent: #10b981; --danger: #dc2626; --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --border: #e2e8f0; --inp-bg: #f1f5f9; }
        .dark-mode { --primary: #f1f5f9; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; --inp-bg: #334155; }
        
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; overflow: hidden; transition: 0.3s; }
        #app-shell { display: flex; height: 100vh; flex-direction: column; }
        @media (min-width: 1024px) { #app-shell { flex-direction: row; } }
        
        #sidebar { background: #001f2d; display: flex; overflow-x: auto; padding: 0.5rem; flex-shrink: 0; border-bottom: 4px solid var(--secondary); }
        @media (min-width: 1024px) { #sidebar { flex-direction: column; width: 260px; height: 100vh; padding: 1.5rem; border-right: none; overflow-y: auto; } }

        .nav-item { padding: 12px 14px; border-radius: 8px; font-weight: 700; color: #94a3b8; font-size: 11px; text-transform: uppercase; cursor: pointer; white-space: nowrap; margin-right: 5px; transition: 0.2s; }
        @media (min-width: 1024px) { .nav-item { margin-right: 0; margin-bottom: 5px; } }
        .nav-item.active { background: var(--secondary); color: white; box-shadow: 0 4px 12px rgba(24, 154, 211, 0.4); }

        .page { display: none; height: 100%; overflow-y: auto; padding: 1rem; padding-bottom: 150px; flex: 1; }
        .page.active { display: block; animation: fade 0.3s; }

        .card { background: var(--card); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border); margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .table-wrap { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border); background: var(--card); }
        table { width: 100%; min-width: 1000px; text-align: left; border-collapse: collapse; }
        th { background: #001f2d; color: white; padding: 12px; font-size: 10px; text-transform: uppercase; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 11px; font-weight: 600; color: var(--text); }
        
        .inp { width: 100%; padding: 10px; background: var(--inp-bg); border: 1px solid var(--border); border-radius: 6px; font-weight: 600; font-size: 11px; margin-bottom: 5px; color: var(--text); outline: none; }
        .btn { padding: 10px 16px; border-radius: 6px; font-weight: 800; font-size: 10px; text-transform: uppercase; color: white; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-blue { background: var(--secondary); } .btn-green { background: var(--accent); } .btn-red { background: var(--danger); } .btn-add { padding: 2px 6px; font-size: 10px; margin-left: 5px; background: #001f2d; color: white; border-radius: 4px; cursor: pointer;}

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 50; align-items: center; justify-content: center; backdrop-filter: blur(2px); padding: 10px; }
        .modal.active { display: flex; }
        .modal-box { background: var(--card); width: 100%; max-width: 1000px; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 16px; border-top: 6px solid var(--secondary); color: var(--text); }

        #chat-bubble { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; cursor: pointer; z-index: 100; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        #chat-box { position: fixed; bottom: 100px; right: 30px; width: 320px; height: 450px; background: var(--card); border-radius: 20px; border: 2px solid var(--secondary); display: none; flex-direction: column; z-index: 99; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        
        .tooth-grid { display: grid; grid-template-columns: repeat(16, 1fr); gap: 2px; }
        .tooth-btn { height: 30px; border: 1px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 9px; font-weight: 900; background: var(--inp-bg); color: var(--text); }
        .tooth-btn.active { background: #ffd700; color: black; border-color: #eab308; box-shadow: 0 0 10px #ffd700; }

        @media print {
            body * { visibility: hidden; }
            .table-wrap, .table-wrap * { visibility: visible; }
            .table-wrap { position: absolute; left: 0; top: 0; width: 100%; }
            th:last-child, td:last-child { display: none !important; }
        }
    </style>
</head>
<body>

    <div id="auth-layer" class="fixed inset-0 bg-[#001f2d] z-[9999] flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-md text-center border-b-8 border-[#189ad3]">
            <h1 class="text-5xl font-black text-[#189ad3] italic mb-2">DAP HUB</h1>
            <div id="login-form">
                <input id="l-user" class="inp text-center uppercase" placeholder="USERNAME">
                <input id="l-pass" type="password" class="inp text-center" placeholder="PASSWORD">
                <button onclick="login()" class="btn btn-blue w-full py-3 text-sm mt-2 shadow-lg">LOGIN SYSTEM</button>
                <p onclick="toggleReg(true)" class="mt-4 text-xs font-bold text-gray-400 cursor-pointer">REQUEST ACCOUNT</p>
            </div>
            <div id="reg-form" class="hidden">
                <input id="r-name" class="inp text-center uppercase" placeholder="FULL NAME">
                <select id="r-role" class="inp text-center font-bold">
                    <option value="DENTIST">DENTIST</option>
                    <option value="ACCOUNTING">ACCOUNTING</option>
                    <option value="HR">HR</option>
                    <option value="IT">IT</option>
                    <option value="ADMIN">ADMIN</option>
                </select>
                <input id="r-pass" type="password" class="inp text-center" placeholder="PASSWORD">
                <button onclick="register()" class="btn btn-green w-full py-3 text-sm mt-2">SUBMIT</button>
                <p onclick="toggleReg(false)" class="mt-4 text-xs font-bold text-gray-400 cursor-pointer">BACK TO LOGIN</p>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden">
        <div id="sidebar">
            <h2 class="hidden lg:block text-2xl font-black text-[#189ad3] italic mb-6">DAP HUB</h2>
            <div id="nav-list" class="flex lg:flex-col"></div>
            <button onclick="logout()" class="btn btn-red lg:mt-auto ml-auto lg:ml-0">LOGOUT</button>
        </div>

        <main class="flex-1 relative">
            <section id="p-dashboard" class="page">
                <h1 class="text-2xl font-black uppercase mb-6">Dashboard</h1>
                <div id="stats-grid" class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div class="card"><h4 class="font-bold mb-4">Production</h4><canvas id="chart1"></canvas></div>
                    <div class="card"><h4 class="font-bold mb-4">Status Ratio</h4><canvas id="chartPie"></canvas></div>
                </div>
            </section>

            <section id="p-dentist" class="page">
                <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-black italic">Dentists</h1><div class="flex gap-2"><button onclick="modal('den')" class="btn btn-green">ADD</button><button onclick="pdf('t-den')" class="btn btn-red">PDF</button></div></div>
                <div class="table-wrap"><table id="t-den"><thead><tr><th>ID</th><th>NAME</th><th>CLINIC</th><th>PHONE</th><th>PRC</th><th>LOC</th><th>ACTION</th></tr></thead><tbody id="b-den"></tbody></table></div>
            </section>

            <section id="p-order" class="page">
                <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-black italic text-[#189ad3]">Orders</h1><div class="flex gap-2"><button onclick="modal('ord')" class="btn btn-green">NEW</button><button onclick="pdf('t-ord')" class="btn btn-red">PDF</button></div></div>
                <div class="table-wrap"><table id="t-ord"><thead><tr><th>ID</th><th>PATIENT</th><th>DENTIST</th><th>STATUS</th><th>DUE</th><th>TOTAL</th><th>ACTION</th></tr></thead><tbody id="b-ord"></tbody></table></div>
            </section>

            <section id="p-product" class="page">
                <div class="flex justify-between items-center mb-4"><h1 class="text-2xl font-black italic text-[#d97706]">Queue</h1><button onclick="pdf('t-prod')" class="btn btn-red">PDF</button></div>
                <div class="table-wrap"><table id="t-prod"><thead><tr><th>ORD ID</th><th>DUE</th><th>STATUS</th><th>ASSIGNED</th><th>REMARKS</th><th>ACTION</th></tr></thead><tbody id="b-prod"></tbody></table></div>
            </section>

            <section id="p-accounting" class="page">
                <h1 class="text-2xl font-black mb-6">Pricing</h1>
                <div id="price-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                <button onclick="savePrices()" class="btn btn-blue w-full py-4 mt-4">UPDATE PRICES</button>
            </section>

            <section id="p-voucher" class="page">
                <h1 class="text-2xl font-black mb-6">Vouchers</h1>
                <div class="card">
                    <div id="v-exp-div" class="hidden">
                        <label>CODE</label><input id="v-code" class="inp uppercase">
                        <label>DISCOUNT %</label><input id="v-pct" type="number" class="inp">
                        <label>EXPIRY DATE</label><input id="v-exp" type="date" class="inp">
                        <button onclick="addVouch()" class="btn btn-blue w-full mt-2">ADD</button>
                    </div>
                </div>
                <div id="v-list" class="space-y-2 mt-4"></div>
            </section>

            <section id="p-users" class="page">
                <h1 class="text-2xl font-black mb-6">Users</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="card"><h3>PENDING</h3><div id="u-pen"></div></div><div class="card"><h3>ACTIVE</h3><div id="u-act"></div></div></div>
            </section>

            <section id="p-settings" class="page">
                <h1 class="text-2xl font-black mb-6">Settings</h1>
                <button onclick="resetSys()" class="btn btn-red w-full py-4">FACTORY RESET (KEEP ACCOUNTS)</button>
            </section>
        </main>
    </div>

    <div id="chat-box">
        <div class="bg-[#189ad3] p-3 text-white font-bold flex justify-between rounded-t-xl"><span>CHAT</span><button onclick="toggleChat()">X</button></div>
        <div class="p-2 border-b bg-white"><select id="chat-to" class="inp mb-0" onchange="rChat()"></select></div>
        <div id="chat-body" class="flex-1 p-3 overflow-y-auto bg-slate-100 text-xs space-y-2"></div>
        <div class="p-2 border-t bg-white flex gap-2"><input id="chat-in" class="inp mb-0" placeholder="Type..."><button onclick="sendChat()" class="btn btn-blue">></button></div>
    </div>
    <div id="chat-bubble" onclick="toggleChat()">ðŸ’¬</div>

    <div id="mod-den" class="modal"><div class="modal-box"><h2>DENTIST</h2><input type="hidden" id="d-idx"><input id="d-id" class="inp" readonly><input id="d-name" class="inp" placeholder="NAME"><input id="d-clinic" class="inp" placeholder="CLINIC"><input id="d-phone" class="inp" placeholder="PHONE"><select id="d-loc" class="inp"></select><div class="flex justify-end gap-2 mt-4"><button onclick="closeModals()" class="btn btn-red">CANCEL</button><button onclick="saveDen()" class="btn btn-green">SAVE</button></div></div></div>

    <div id="mod-ord" class="modal"><div class="modal-box"><h2>ORDER</h2><input type="hidden" id="o-idx"><input id="o-id" class="inp" readonly><select id="o-den" class="inp" onchange="fillPhone()"></select><input id="o-pat" class="inp" placeholder="PATIENT"><input id="o-date" type="date" class="inp"><input id="o-due" type="date" class="inp"><select id="o-pay" class="inp"><option value="CASH">CASH</option><option value="CARD">CARD</option><option value="GCASH">GCASH</option></select><div id="o-prods" class="h-32 border overflow-y-auto p-2 mb-2"></div><div id="o-tot" class="p-4 bg-black text-white text-center font-bold">TOTAL: â‚±0</div><div class="flex justify-end gap-2 mt-4"><button onclick="closeModals()" class="btn btn-red">CANCEL</button><button onclick="saveOrd()" class="btn btn-green">SAVE</button></div></div></div>

    <script>
        const PRODS = ["PFM", "EMAX", "ZIRCONIA", "VENEERS", "TEMPORARY"];
        let S = {
            u: JSON.parse(localStorage.getItem('dap_fx_v9_u')) || [{ n: 'ADMIN', p: '123', d: 'IT', s: 'active' }],
            d: JSON.parse(localStorage.getItem('dap_fx_v9_d')) || [],
            o: JSON.parse(localStorage.getItem('dap_fx_v9_o')) || [],
            v: JSON.parse(localStorage.getItem('dap_fx_v9_v')) || [],
            pr: JSON.parse(localStorage.getItem('dap_fx_v9_pr')) || {},
            hr: JSON.parse(localStorage.getItem('dap_fx_v9_hr')) || [],
            locs: JSON.parse(localStorage.getItem('dap_fx_v9_locs')) || ["MANILA"],
            stats: ["PENDING", "ONGOING", "DONE"],
            pstats: ["ONGOING", "REJECTED", "APPROVED"],
            msg: JSON.parse(localStorage.getItem('dap_fx_v9_msg')) || [],
            curr: null
        };
        PRODS.forEach(p => { if (!S.pr[p]) S.pr[p] = 1500; });

        function sv() { localStorage.setItem('dap_fx_v9_u', JSON.stringify(S.u)); localStorage.setItem('dap_fx_v9_d', JSON.stringify(S.d)); localStorage.setItem('dap_fx_v9_o', JSON.stringify(S.o)); localStorage.setItem('dap_fx_v9_v', JSON.stringify(S.v)); localStorage.setItem('dap_fx_v9_pr', JSON.stringify(S.pr)); localStorage.setItem('dap_fx_v9_msg', JSON.stringify(S.msg)); localStorage.setItem('dap_fx_v9_hr', JSON.stringify(S.hr)); }

        function login() {
            let u = document.getElementById('l-user').value.toUpperCase(), p = document.getElementById('l-pass').value;
            let acc = S.u.find(x => x.n === u && x.p === p);
            if (!acc) return alert('INVALID'); S.curr = acc;
            document.getElementById('auth-layer').classList.add('hidden'); document.getElementById('app-shell').classList.remove('hidden');
            initNav(); initChat();
        }
        function logout() { location.reload(); }
        function toggleReg(x) { document.getElementById('login-form').classList.toggle('hidden', x); document.getElementById('reg-form').classList.toggle('hidden', !x); }
        function register() { let n = document.getElementById('r-name').value.toUpperCase(), r = document.getElementById('r-role').value, p = document.getElementById('r-pass').value; if (!n || !p) return alert('MISSING INPUT'); S.u.push({ n, d: r, p, s: 'pending' }); sv(); alert('SENT'); toggleReg(false); }

        function initNav() {
            let r = S.curr.d, p = [];
            if (r === 'DENTIST') p = ['dentist', 'order', 'product'];
            else if (r === 'ACCOUNTING') p = ['dashboard', 'accounting', 'voucher', 'settings'];
            else p = ['dashboard', 'dentist', 'order', 'product', 'accounting', 'voucher', 'users', 'settings'];
            document.getElementById('nav-list').innerHTML = p.map(x => `<div onclick="go('${x}')" id="nav-${x}" class="nav-item">${x}</div>`).join('');
            go(p[0]);
        }
        function go(id) {
            document.querySelectorAll('.page').forEach(e => e.classList.remove('active')); document.getElementById('p-' + id).classList.add('active');
            if (id === 'dashboard') dash(); if (id === 'dentist') rDen(); if (id === 'order') rOrd(); if (id === 'product') rProd(); if (id === 'accounting') rAcc(); if (id === 'voucher') rVouch(); if (id === 'users') rUsers();
        }

        function dash() {
            document.getElementById('stats-grid').innerHTML = `<div class="card"><b>ORDERS</b><h2>${S.o.length}</h2></div><div class="card"><b>REVENUE</b><h2>â‚±${S.o.reduce((a, b) => a + parseInt(b.tot.replace(/,/g, '') || 0), 0).toLocaleString()}</h2></div>`;
        }

        function rDen() { let adm = (S.curr.d === 'IT' || S.curr.d === 'ADMIN'); document.getElementById('b-den').innerHTML = S.d.map((x, i) => `<tr><td>${x.id}</td><td>${x.n}</td><td>${x.c}</td><td>${x.p}</td><td>${x.prc || ''}</td><td>${x.loc}</td><td><button onclick="edDen(${i})">EDIT</button></td></tr>`).join(''); }
        function rOrd() { document.getElementById('b-ord').innerHTML = S.o.map((x, i) => `<tr><td>${x.id}</td><td>${x.pat}</td><td>${x.den}</td><td>${x.st}</td><td>${x.due}</td><td>â‚±${x.tot}</td><td><button onclick="del('o',${i})">DEL</button></td></tr>`).join(''); }
        function rProd() { document.getElementById('b-prod').innerHTML = S.o.map((x, i) => `<tr><td>${x.id}</td><td>${x.due}</td><td>${x.p_st || 'ONGOING'}</td><td>${x.asn || ''}</td><td>${x.rem || ''}</td><td><button onclick="upP(${i},'p_st','DONE')">DONE</button></td></tr>`).join(''); }
        function upP(i, f, v) { S.o[i][f] = v; sv(); rProd(); }
        function rAcc() { document.getElementById('price-grid').innerHTML = PRODS.map(p => `<div class="card"><b>${p}</b><input class="inp p-in" data-p="${p}" value="${S.pr[p]}"></div>`).join(''); }
        function savePrices() { document.querySelectorAll('.p-in').forEach(i => S.pr[i.dataset.p] = parseInt(i.value)); sv(); alert('SAVED'); }
        
        function rVouch() { 
            let can = (['IT', 'ADMIN', 'ACCOUNTING'].includes(S.curr.d)); 
            document.getElementById('v-exp-div').classList.toggle('hidden', !can);
            document.getElementById('v-list').innerHTML = S.v.map(v => `<div class="card"><b>${v.c} (-${v.p}%)</b><br><small>EXP: ${v.e || 'NONE'}</small></div>`).join('');
        }

        function rUsers() { document.getElementById('u-pen').innerHTML = S.u.filter(x => x.s === 'pending').map(x => `<div>${x.n} <button onclick="uAct('${x.n}','active')">OK</button></div>`).join(''); document.getElementById('u-act').innerHTML = S.u.filter(x => x.s === 'active').map(x => `<div>${x.n} [${x.d}]</div>`).join(''); }
        function uAct(n, s) { S.u.find(x => x.n === n).s = s; sv(); rUsers(); }

        // --- FINAL PDF LOGIC ---
        function pdf(id) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            doc.text("DAP HUB REPORT", 40, 40);
            doc.autoTable({
                html: '#' + id,
                startY: 60,
                didParseCell: function(data) {
                    if (id === 't-ord' && data.row.section === 'body' && data.column.index === 5) {
                        let idx = data.row.index;
                        if(S.o[idx]) data.cell.text = [S.o[idx].tot + ' (' + (S.o[idx].pay || 'CASH') + ')'];
                    }
                    let el = data.cell.raw;
                    if (el && el.tagName === 'TD') {
                        let s = el.querySelector('select'), i = el.querySelector('input');
                        if (s) data.cell.text = [s.options[s.selectedIndex].text];
                        else if (i) data.cell.text = [i.value];
                    }
                },
                columns: function(colIdx) { return colIdx < (document.getElementById(id).rows[0].cells.length - 1); }
            });
            doc.save('Report.pdf');
        }

        function modal(t) {
            if (t === 'ord') { document.getElementById('o-date').value = new Date().toISOString().split('T')[0]; document.getElementById('o-den').innerHTML = S.d.map(x => `<option>${x.n}</option>`).join(''); document.getElementById('mod-ord').classList.add('active'); }
            if (t === 'den') { popSel('d-loc', S.locs); document.getElementById('mod-den').classList.add('active'); }
        }
        function saveOrd() { let p = document.getElementById('o-pat').value, d = document.getElementById('o-den').value; S.o.push({ id: 'ORD-' + (S.o.length + 1), pat: p.toUpperCase(), den: d, st: 'PENDING', due: document.getElementById('o-due').value, tot: '0', pay: document.getElementById('o-pay').value }); sv(); rOrd(); closeModals(); }
        function saveDen() { S.d.push({ id: 'D-' + (S.d.length + 1), n: document.getElementById('d-name').value.toUpperCase(), c: document.getElementById('d-clinic').value, p: document.getElementById('d-phone').value, loc: document.getElementById('d-loc').value }); sv(); rDen(); closeModals(); }
        function closeModals() { document.querySelectorAll('.modal').forEach(x => x.classList.remove('active')); }
        function popSel(id, a) { document.getElementById(id).innerHTML = a.map(x => `<option value="${x}">${x}</option>`).join('') + '<option value="ADD">+ ADD</option>'; }
        function addOpt(t) { let v = prompt('NEW:'); if (v) { if (t === 'loc') S.locs.push(v); sv(); popSel('d-loc', S.locs); } }
        function initChat() { let r = S.curr.d; let list = S.u.filter(x => { if (r === 'DENTIST') return ['ADMIN', 'IT', 'ACCOUNTING', 'HR'].includes(x.d); return x.n !== S.curr.n; }); document.getElementById('chat-to').innerHTML = `<option value="">SELECT</option>` + list.map(x => `<option value="${x.n}">${x.n}</option>`).join(''); }
        function toggleChat() { let b = document.getElementById('chat-box'); b.style.display = b.style.display === 'flex' ? 'none' : 'flex'; }
        function resetSys() { if (confirm('RESET?')) { S.d = []; S.o = []; S.v = []; sv(); location.reload(); } }
        setInterval(() => { if(document.getElementById('clock')) document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
    </script>
</body>
</html>
